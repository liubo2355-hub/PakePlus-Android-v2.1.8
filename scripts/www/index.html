<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿç‚¹åç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 450px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .nav-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .nav-btn.active {
            background: #4F46E5;
            color: white;
        }
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .card-title {
            font-size: 20px;
            font-weight: bold;
            color: #1E293B;
            margin-bottom: 15px;
            text-align: center;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        input {
            flex: 1;
            padding: 12px;
            border: 2px solid #E2E8F0;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        input:focus {
            border-color: #4F46E5;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-success {
            background: #10B981;
            color: white;
        }
        .btn-danger {
            background: #EF4444;
            color: white;
        }
        .btn-warning {
            background: #F59E0B;
            color: white;
        }
        .btn-primary {
            background: #4F46E5;
            color: white;
        }
        .btn-purple {
            background: #8B5CF6;
            color: white;
        }
        .student-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #E2E8F0;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #F1F5F9;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .student-item:last-child {
            margin-bottom: 0;
        }
        .roll-result {
            text-align: center;
            padding: 40px 20px;
            background: #F1F5F9;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #DC2626;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .stat-item {
            text-align: center;
            padding: 10px 15px;
            background: #F1F5F9;
            border-radius: 8px;
        }
        .stat-num {
            font-size: 20px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 12px;
            color: #94A3B8;
        }
        .status-msg {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .status-success {
            background: #D1FAE5;
            color: #059669;
        }
        .status-error {
            background: #FEE2E2;
            color: #DC2626;
        }
        .history-item {
            padding: 15px;
            background: #F1F5F9;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .history-date {
            font-size: 16px;
            font-weight: bold;
            color: #4F46E5;
            margin-bottom: 5px;
        }
        .history-info {
            font-size: 14px;
            color: #475569;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ å­¦ç”Ÿç‚¹åç³»ç»Ÿ</h1>
        </div>
        
        <div class="nav">
            <button class="nav-btn active" onclick="showScreen('student')">å­¦ç”Ÿç®¡ç†</button>
            <button class="nav-btn" onclick="showScreen('rollcall')">éšæœºç‚¹å</button>
            <button class="nav-btn" onclick="showScreen('attendance')">ç­¾åˆ°</button>
            <button class="nav-btn" onclick="showScreen('history')">å†å²</button>
        </div>
        
        <!-- å­¦ç”Ÿç®¡ç†ç•Œé¢ -->
        <div id="student-screen" class="screen">
            <div class="card">
                <div class="card-title">ğŸ‘¥ å­¦ç”Ÿç®¡ç†</div>
                <div class="input-group">
                    <input type="text" id="student-name" placeholder="å­¦ç”Ÿå§“å">
                    <input type="text" id="student-code" placeholder="ç¼–ç ï¼ˆ5ä½ï¼‰" style="width: 100px;">
                    <button class="btn btn-success" onclick="addStudent()">æ·»åŠ </button>
                </div>
                <div id="student-list" class="student-list"></div>
                <div class="input-group">
                    <button class="btn btn-purple" onclick="showBatchImport()" style="flex:1;">æ‰¹é‡å¯¼å…¥</button>
                </div>
                <div class="input-group">
                    <button class="btn btn-danger" onclick="deleteSelected()" style="flex:1;">åˆ é™¤é€‰ä¸­</button>
                    <button class="btn btn-warning" onclick="clearAllStudents()" style="flex:1;">æ¸…ç©ºåå•</button>
                </div>
                
                <!-- æ‰¹é‡å¯¼å…¥å¼¹çª— -->
                <div id="batch-import-modal" class="hidden" style="position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="card" style="width: 90%; max-width: 400px;">
                        <div class="card-title">ğŸ“¥ æ‰¹é‡å¯¼å…¥å­¦ç”Ÿ</div>
                        <p style="font-size:12px; color:#94A3B8; margin-bottom:10px;">æ¯è¡Œä¸€ä¸ªå­¦ç”Ÿï¼Œæ ¼å¼ï¼šå§“å,ç¼–ç ï¼ˆç¼–ç å¯é€‰ï¼‰</p>
                        <p style="font-size:12px; color:#94A3B8; margin-bottom:15px;">ä¾‹å¦‚ï¼šå¼ ä¸‰,00001 æˆ– æå››</p>
                        <textarea id="batch-input" style="width:100%; height:150px; padding:10px; border:2px solid #E2E8F0; border-radius:10px; font-size:14px; resize:none; margin-bottom:15px;" placeholder="å¼ ä¸‰,00001&#10;æå››&#10;ç‹äº”,00003"></textarea>
                        <div class="input-group">
                            <button class="btn btn-purple" onclick="doBatchImport()" style="flex:1;">ç¡®è®¤å¯¼å…¥</button>
                            <button class="btn btn-warning" onclick="hideBatchImport()" style="flex:1;">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- éšæœºç‚¹åç•Œé¢ -->
        <div id="rollcall-screen" class="screen hidden">
            <div class="card">
                <div class="card-title">ğŸ² éšæœºç‚¹å</div>
                <div class="input-group">
                    <span style="padding: 12px; color: #475569;">ç‚¹åäººæ•°:</span>
                    <input type="number" id="roll-num" value="1" min="1" style="width: 80px;">
                    <button class="btn btn-primary" onclick="randomRollCall()">éšæœºç‚¹å</button>
                </div>
                <div class="roll-result" id="roll-result">ç­‰å¾…ç‚¹å...</div>
                <div id="roll-progress" style="text-align: center; color: #94A3B8;"></div>
            </div>
        </div>
        
        <!-- ç­¾åˆ°ç•Œé¢ -->
        <div id="attendance-screen" class="screen hidden">
            <div class="card">
                <div class="card-title">âœ… å­¦ç”Ÿç­¾åˆ°</div>
                <div id="attendance-status" class="status-msg hidden"></div>
                <div class="stats" id="attendance-stats"></div>
                <div class="input-group">
                    <input type="text" id="attendance-code" placeholder="è¯·è¾“å…¥ç¼–ç ï¼ˆé€—å·åˆ†éš”æ‰¹é‡ï¼‰">
                    <button class="btn btn-success" onclick="checkCode()">ç­¾åˆ°</button>
                </div>
                <div id="attended-list" class="student-list"></div>
                <button class="btn btn-primary" style="width:100%;" onclick="finishAttendance()">å®Œæˆç­¾åˆ°</button>
            </div>
        </div>
        
        <!-- å†å²è®°å½•ç•Œé¢ -->
        <div id="history-screen" class="screen hidden">
            <div class="card">
                <div class="card-title">ğŸ“… ç­¾åˆ°å†å²</div>
                <div id="history-list"></div>
            </div>
        </div>
    </div>
    
    <script>
        let students = [];
        let attendanceRecords = {};
        let currentIndex = 0;
        let attendedStudents = [];
        let selectedStudents = new Set();
        let isAnimating = false;
        
        function loadData() {
            const saved = localStorage.getItem('studentRollCallData');
            if (saved) {
                const data = JSON.parse(saved);
                students = data.students || [];
                attendanceRecords = data.attendance || {};
                currentIndex = data.currentIndex || 0;
            }
            updateStudentList();
            updateAttendanceStats();
            updateHistoryList();
        }
        
        function saveData() {
            const data = {
                students: students,
                attendance: attendanceRecords,
                currentIndex: currentIndex
            };
            localStorage.setItem('studentRollCallData', JSON.stringify(data));
        }
        
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(screen + '-screen').classList.remove('hidden');
            event.target.classList.add('active');
            
            if (screen === 'attendance') {
                initAttendance();
            }
        }
        
        function addStudent() {
            const name = document.getElementById('student-name').value.trim();
            let code = document.getElementById('student-code').value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥å­¦ç”Ÿå§“åï¼');
                return;
            }
            
            if (students.some(s => s.name === name)) {
                alert('å­¦ç”Ÿ "' + name + '" å·²å­˜åœ¨ï¼');
                return;
            }
            
            if (code) {
                if (!code.match(/^\d{5}$/)) {
                    alert('ç¼–ç å¿…é¡»æ˜¯5ä½æ•°å­—ï¼');
                    return;
                }
                if (students.some(s => s.code === code)) {
                    alert('ç¼–ç  "' + code + '" å·²å­˜åœ¨ï¼');
                    return;
                }
            } else {
                if (students.length > 0) {
                    const maxCode = Math.max(...students.map(s => parseInt(s.code)));
                    code = String(maxCode + 1).padStart(5, '0');
                } else {
                    code = '00001';
                }
            }
            
            students.push({name: name, code: code});
            saveData();
            updateStudentList();
            document.getElementById('student-name').value = '';
            document.getElementById('student-code').value = '';
        }
        
        function updateStudentList() {
            const list = document.getElementById('student-list');
            list.innerHTML = '';
            selectedStudents.clear();
            
            students.forEach((student, index) => {
                const item = document.createElement('div');
                item.className = 'student-item';
                item.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" onchange="toggleSelect(${index}, this.checked)">
                        <span>${student.name} (${student.code})</span>
                    </label>
                `;
                list.appendChild(item);
            });
        }
        
        function toggleSelect(index, checked) {
            if (checked) {
                selectedStudents.add(index);
            } else {
                selectedStudents.delete(index);
            }
        }
        
        function deleteSelected() {
            if (selectedStudents.size === 0) {
                alert('è¯·å…ˆé€‰ä¸­è¦åˆ é™¤çš„å­¦ç”Ÿï¼');
                return;
            }
            
            const toDelete = Array.from(selectedStudents).sort((a, b) => b - a);
            toDelete.forEach(idx => students.splice(idx, 1));
            saveData();
            updateStudentList();
        }
        
        function clearAllStudents() {
            if (students.length === 0) return;
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿï¼Ÿ')) {
                students = [];
                saveData();
                updateStudentList();
            }
        }
        
        function showBatchImport() {
            document.getElementById('batch-import-modal').classList.remove('hidden');
            document.getElementById('batch-input').value = '';
        }
        
        function hideBatchImport() {
            document.getElementById('batch-import-modal').classList.add('hidden');
        }
        
        function doBatchImport() {
            const text = document.getElementById('batch-input').value.trim();
            if (!text) {
                alert('è¯·è¾“å…¥å­¦ç”Ÿä¿¡æ¯ï¼');
                return;
            }
            
            const lines = text.split('\n');
            let added = 0;
            let skipped = 0;
            
            let maxCode = students.length > 0 ? Math.max(...students.map(s => parseInt(s.code))) : 0;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                let name, code;
                if (line.includes(',')) {
                    const parts = line.split(',');
                    name = parts[0].trim();
                    code = parts[1].trim();
                    
                    if (code && (!code.match(/^\d{5}$/))) {
                        alert('ç¼–ç æ ¼å¼é”™è¯¯ï¼š' + line + '\nç¼–ç å¿…é¡»æ˜¯5ä½æ•°å­—ï¼');
                        return;
                    }
                } else {
                    name = line;
                    code = null;
                }
                
                if (!name) return;
                
                if (students.some(s => s.name === name)) {
                    skipped++;
                    return;
                }
                
                if (code && students.some(s => s.code === code)) {
                    skipped++;
                    return;
                }
                
                if (!code) {
                    maxCode++;
                    code = String(maxCode).padStart(5, '0');
                } else {
                    const codeNum = parseInt(code);
                    if (codeNum > maxCode) {
                        maxCode = codeNum;
                    }
                }
                
                students.push({name: name, code: code});
                added++;
            });
            
            saveData();
            updateStudentList();
            hideBatchImport();
            
            let msg = 'æˆåŠŸå¯¼å…¥ ' + added + ' åå­¦ç”Ÿ';
            if (skipped > 0) {
                msg += '\nè·³è¿‡ ' + skipped + ' ä¸ªé‡å¤é¡¹';
            }
            alert(msg);
        }
        
        function randomRollCall() {
            if (students.length === 0) {
                alert('åå•ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ å­¦ç”Ÿï¼');
                return;
            }
            if (isAnimating) return;
            
            const num = Math.max(1, parseInt(document.getElementById('roll-num').value) || 1);
            if (num > students.length) {
                alert('ç‚¹åäººæ•°è¶…è¿‡å­¦ç”Ÿæ€»æ•°ï¼');
                return;
            }
            
            isAnimating = true;
            const targets = [];
            const temp = [...students];
            for (let i = 0; i < num; i++) {
                const idx = Math.floor(Math.random() * temp.length);
                targets.push(temp.splice(idx, 1)[0]);
            }
            
            let step = 0;
            const totalSteps = 22;
            const resultEl = document.getElementById('roll-result');
            
            const animate = () => {
                step++;
                if (step < totalSteps) {
                    const sample = [];
                    const temp2 = [...students];
                    for (let i = 0; i < num; i++) {
                        const idx = Math.floor(Math.random() * temp2.length);
                        sample.push(temp2.splice(idx, 1)[0]);
                    }
                    resultEl.textContent = sample.map(s => s.name).join('ã€');
                    resultEl.style.color = '#4F46E5';
                    setTimeout(animate, 50 + step * 15);
                } else {
                    resultEl.textContent = targets.map(s => s.name).join('ã€');
                    resultEl.style.color = '#DC2626';
                    document.getElementById('roll-progress').textContent = 'éšæœºç‚¹åå®Œæˆ (å…± ' + num + ' äºº)';
                    isAnimating = false;
                }
            };
            animate();
        }
        
        function initAttendance() {
            const today = new Date().toISOString().split('T')[0];
            attendedStudents = [...(attendanceRecords[today] || [])];
            updateAttendanceStats();
            updateAttendedList();
        }
        
        function updateAttendanceStats() {
            const stats = document.getElementById('attendance-stats');
            const attended = attendedStudents.length;
            const notAttended = students.length - attended;
            stats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-num" style="color: #10B981;">${attended}</div>
                    <div class="stat-label">å·²ç­¾åˆ°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-num" style="color: #EF4444;">${notAttended}</div>
                    <div class="stat-label">æœªç­¾åˆ°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-num" style="color: #475569;">${students.length}</div>
                    <div class="stat-label">æ€»äººæ•°</div>
                </div>
            `;
        }
        
        function updateAttendedList() {
            const list = document.getElementById('attended-list');
            list.innerHTML = '';
            attendedStudents.forEach((student, index) => {
                const item = document.createElement('div');
                item.className = 'student-item';
                item.innerHTML = `<span>${index + 1}. ${student.name} (${student.code})</span>`;
                list.appendChild(item);
            });
        }
        
        function showStatus(msg, type) {
            const status = document.getElementById('attendance-status');
            status.textContent = msg;
            status.className = 'status-msg status-' + type;
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 3000);
        }
        
        function checkCode() {
            const codeInput = document.getElementById('attendance-code').value.trim();
            if (!codeInput) {
                showStatus('è¯·è¾“å…¥ç¼–ç ï¼', 'error');
                return;
            }
            
            const codes = codeInput.split(',').map(c => c.trim()).filter(c => c);
            let successCount = 0;
            const errors = [];
            const successful = [];
            
            codes.forEach(code => {
                if (!code.match(/^\d{5}$/)) {
                    errors.push('ç¼–ç  ' + code + ' å¿…é¡»æ˜¯5ä½æ•°å­—');
                    return;
                }
                
                const student = students.find(s => s.code === code);
                if (!student) {
                    errors.push('ç¼–ç  ' + code + ' ä¸å­˜åœ¨');
                    return;
                }
                
                if (attendedStudents.some(s => s.code === code)) {
                    errors.push(student.name + ' å·²ç­¾åˆ°');
                    return;
                }
                
                attendedStudents.push(student);
                successful.push(student);
                successCount++;
            });
            
            if (successCount > 0) {
                if (successCount === 1) {
                    showStatus(successful[0].name + ' ç­¾åˆ°æˆåŠŸï¼', 'success');
                } else {
                    showStatus('æˆåŠŸç­¾åˆ° ' + successCount + ' åå­¦ç”Ÿï¼', 'success');
                }
                updateAttendanceStats();
                updateAttendedList();
            }
            
            if (errors.length > 0) {
                showStatus(errors.join('ã€'), 'error');
            }
            
            document.getElementById('attendance-code').value = '';
        }
        
        function finishAttendance() {
            if (attendedStudents.length === 0) {
                alert('æš‚æ— å­¦ç”Ÿç­¾åˆ°ï¼');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            attendanceRecords[today] = [...attendedStudents];
            saveData();
            
            alert('ç­¾åˆ°å®Œæˆï¼\næ—¥æœŸ: ' + today + '\nç­¾åˆ°äººæ•°: ' + attendedStudents.length + ' äºº');
            updateHistoryList();
        }
        
        function updateHistoryList() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            const dates = Object.keys(attendanceRecords).sort().reverse();
            if (dates.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #94A3B8; padding: 40px;">æš‚æ— ç­¾åˆ°è®°å½•</div>';
                return;
            }
            
            dates.forEach(date => {
                const records = attendanceRecords[date];
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-date">ğŸ“… ${date}</div>
                    <div class="history-info">ç­¾åˆ°äººæ•°: ${records.length}/${students.length}</div>
                    ${records.length > 0 ? '<div class="history-info">å­¦ç”Ÿ: ' + records.map(s => s.name).join('ã€') + '</div>' : ''}
                `;
                list.appendChild(item);
            });
        }
        
        loadData();
    </script>
</body>
</html>
